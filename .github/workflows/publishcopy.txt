name: CI/CD Pipeline

on:
  push:
    branches:
      - motohelp
  pull_request:
    branches:
      - motohelp

jobs:
  build:
    runs-on: self-hosted 
    steps:
     - name: Checkout code
       uses: actions/checkout@v3 
     - name: Set up Node.js
       uses: actions/setup-node@v3
       with:
         node-version: 20 
     - name: Install dependencies for all services
       shell: cmd
       run: |
         set services=api-gateway vendor-service driver-service customer-service KYC_Verification
         for %%s in (%services%) do (
           if exist %%s\package.json (
             echo Installing dependencies for %%s...
             cd %%s
             npm install
             cd ..
           ) else (
             echo No package.json found in %%s, skipping...
           )
         )
      
     
     - name: Create logs directories
       run: |
         mkdir -p admin-service/log/logs
         mkdir -p api-gateway/log/logs
         mkdir -p customer-service/log/logs
         mkdir -p driver-service/log/logs
         mkdir -p vendor-service/log/logs
         mkdir -p KYC_Verification/log/logs  
    
     - name: Build Docker images
       run: |
         docker build -t api-gateway:${{ github.sha }} -f api-gateway/Dockerfile api-gateway
         docker build -t vendor-service:${{ github.sha }} -f vendor-service/Dockerfile vendor-service
         docker build -t driver-service:${{ github.sha }} -f driver-service/Dockerfile driver-service
         docker build -t customer-service:${{ github.sha }} -f customer-service/Dockerfile customer-service
  

     - name: Log in to Docker Hub
       uses: docker/login-action@v2
       with:
         username: ${{ secrets.DOCKER_USERNAME }}
         password: ${{ secrets.DOCKER_PASSWORD }}
     
     - name: Push Images
       run: |
         docker tag api-gateway:${{ github.sha }} ${{ secrets.DOCKER_USERNAME }}/api-gateway:${{ github.sha }}
         docker tag vendor-service:${{ github.sha }} ${{ secrets.DOCKER_USERNAME }}/vendor-service:${{ github.sha }}
         docker tag driver-service:${{ github.sha }} ${{ secrets.DOCKER_USERNAME }}/driver-service:${{ github.sha }}
         docker tag customer-service:${{ github.sha }} ${{ secrets.DOCKER_USERNAME }}/customer-service:${{ github.sha }}

         docker push ${{ secrets.DOCKER_USERNAME }}/api-gateway:${{ github.sha }}
         docker push ${{ secrets.DOCKER_USERNAME }}/vendor-service:${{ github.sha }}
         docker push ${{ secrets.DOCKER_USERNAME }}/driver-service:${{ github.sha }}
         docker push ${{ secrets.DOCKER_USERNAME }}/customer-service:${{ github.sha }}


  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install sshpass
      run: |
        sudo apt-get update
        sudo apt-get install -y sshpass

    - name: Add SSH known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -p ${{ secrets.LINUXPORT }} ${{ secrets.LINUXIP }} >> ~/.ssh/known_hosts

    - name: Deploy to Linux Server
      env:
        SSHPASS: ${{ secrets.LINUXPASSWORD }}
      run: |

        echo "------ Creating Folder if not exists ------"
        sshpass -e ssh -p ${{ secrets.LINUXPORT }} ${{ secrets.LINUXUSERNAME }}@${{ secrets.LINUXIP }} \
        "mkdir -p /var/www/motohelpindia.com"

        echo "------ Uploading project ------"
        sshpass -e rsync -avz -e "ssh -p ${{ secrets.LINUXPORT }}" \
        "$GITHUB_WORKSPACE/" \
        ${{ secrets.LINUXUSERNAME }}@${{ secrets.LINUXIP }}:/var/www/motohelpindia.com

        echo "------ Creating .env file ------"
        sshpass -e ssh -p ${{ secrets.LINUXPORT }} ${{ secrets.LINUXUSERNAME }}@${{ secrets.LINUXIP }} << 'EOF'
                  cat > /var/www/motohelpindia.com/.env << 'ENV_END'
                  DB_HOST=${{ secrets.DB_HOST }}
                  DB_USER=${{ secrets.DB_USER }}
                  DB_PASSWORD=${{ secrets.DB_PASSWORD }}
                  DB_NAME=${{ secrets.DB_NAME }}
                  PORT=${{ secrets.PORT }}
                  APIPORT=${{ secrets.APIPORT }}
                  ADMINPORT=${{ secrets.ADMINPORT }}
                  VENDORPORT=${{ secrets.VENDORPORT }}
                  DRIVERPORT=${{ secrets.DRIVERPORT }}
                  CUSTOMERPORT=${{ secrets.CUSTOMERPORT }}
                  ADMIN_SERVICE_URL=${{ secrets.ADMIN_SERVICE_URL }}
                  VENDOR_SERVICE_URL=${{ secrets.VENDOR_SERVICE_URL }}
                  DRIVER_SERVICE_URL=${{ secrets.DRIVER_SERVICE_URL }}
                  CUSTOMER_SERVICE_URL=${{ secrets.CUSTOMER_SERVICE_URL }}
                  ENV_END
                  EOF

        echo "------ Restarting Services with PM2 ------"

        # Install dependencies and start the application
          sshpass -e ssh -p ${{ secrets.LINUXPORT }} ${{ secrets.LINUXUSERNAME }}@${{ secrets.LINUXIP }} << 'EOF'
          cd /var/www/motohelpindia.com/api-gateway
          echo "Starting deployment..."

          npm install pm2
          pm2 --version
          echo "pm2 --version"

          node --version
          echo "node --version"

          npm install
          npm --version
          echo "npm -version"
          

          echo "Starting api-gateway application with PM2..."
          pm2 restart index.js || pm2 start index.js

          EOF

           # Install dependencies and start the application
          sshpass -e ssh -p ${{ secrets.LINUXPORT }} ${{ secrets.LINUXUSERNAME }}@${{ secrets.LINUXIP }} << 'EOF'
          cd /var/www/motohelpindia.com/vendor-service
          echo "Starting vendor deployment..."

          npm install pm2
          pm2 --version
          echo "pm2 --version"

          node --version
          echo "node --version"

          npm install
          npm --version
          echo "npm -version"
          

          echo "Starting vendor-service application with PM2..."
          pm2 restart index.js || pm2 start index.js
          EOF


          # Install dependencies and start the application
          sshpass -e ssh -p ${{ secrets.LINUXPORT }} ${{ secrets.LINUXUSERNAME }}@${{ secrets.LINUXIP }} << 'EOF'
          cd /var/www/motohelpindia.com/driver-service
          echo "Starting driver deployment..."

          npm install pm2
          pm2 --version
          echo "pm2 --version"

          node --version
          echo "node --version"

          npm install
          npm --version
          echo "npm -version"
          

          echo "Starting driver-service application with PM2..."
          pm2 restart index.js || pm2 start index.js

          EOF

          # Install dependencies and start the application
          sshpass -e ssh -p ${{ secrets.LINUXPORT }} ${{ secrets.LINUXUSERNAME }}@${{ secrets.LINUXIP }} << 'EOF'
          cd /var/www/motohelpindia.com/customer-service
          echo "Starting customer deployment..."

          npm install pm2
          pm2 --version
          echo "pm2 --version"

          node --version
          echo "node --version"

          npm install
          npm --version
          echo "npm -version"
          

          echo "Starting customer-service application with PM2..."
          pm2 restart index.js || pm2 start index.js
                    
          EOF

          # Install dependencies and start the application
          sshpass -e ssh -p ${{ secrets.LINUXPORT }} ${{ secrets.LINUXUSERNAME }}@${{ secrets.LINUXIP }} << 'EOF'
          cd /var/www/motohelpindia.com/KYC_Verification
          echo "Starting KYC_Verification deployment..."

          npm install pm2
          pm2 --version
          echo "pm2 --version"

          node --version
          echo "node --version"

          npm install
          npm --version
          echo "npm -version"
          

          echo "Starting customer-service application with PM2..."
          
                    
          EOF





          